generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider    = "postgresql"
    url         = env("DATABASE_URL")
}



enum Role {
    ADMIN
    USER
}

enum ClothingSize {
    XS
    S
    M
    L
    XL
}




model User {
    createdAt           DateTime            @default(now())
    updatedAt           DateTime            @updatedAt
    id                  String              @id @default(cuid())

    role                Role                @default(USER)

    // Only hashed password is stored
    password            String

    email               String              @unique
    netId               String              @unique
    phoneNumber         String              @default("")
    displayName         String
    profilePicture      String?

    bankAccount         BankAccount?        @relation("UserBankAccount")

    // Promo codes that the user has redeemed in the past (stored so he can't repeat them)
    promoCodes          String[]            @default([])

    // Auth tokens issued to a user. Only the last token in the array is valid. <-- OUTDATED
    // Auth tokens issued to a user. ALL tokens in the array are valid
    tokens              AuthToken[]         @relation("UserAuthToken")


    // Reset password tokens issued to a user. Only the last token in the array is valid.
    rpTokens            RPToken[]           @relation("UserResetPasswordToken")

    // All reports this user has made on posts
    reports             PostReport[]        @relation("Reporter")

    // All payments a seller has made, for any and all items
    payments            PaymentTransaction[]    @relation("UserPayments")

    // Items posted as a seller
    items               Item[]              @relation("UserItem")

    // Amount of free months a user has available
    freeMonths          Int                 @db.SmallInt

    // Has the account been activated through email?
    active              Boolean             @default(false)
    activateTokens      ActivateToken[]     @relation("EmailVerificationToken")

    // Has this account been deleted?
    deleted             Boolean             @default(false)

    // Has this account been banned?
    banned              Boolean             @default(false)
    banMsg              String?
}




model BankAccount {
    createdAt           DateTime            @default(now())
    updatedAt           DateTime            @updatedAt
    id                  String              @id @default(cuid())

    accountHolderName   String
    accountNumber       String
    routingNumber       String?
    bankName            String?

    userAccount         String              @unique
    user                User                @relation("UserBankAccount", fields: [userAccount], references: [id], onDelete: Cascade)
}




model Item {
    createdAt           DateTime            @default(now())
    updatedAt           DateTime            @updatedAt
    id                  String              @id @default(cuid())

    // Seller who posted the item
    sellerId            String
    seller              User                @relation("UserItem", fields: [sellerId], references: [id], onDelete: Cascade)

    // The payment for this item
    payment             PaymentTransaction? @relation("ItemPayment")
    // How many free months used for the item
    freeMonthsUsed      Int                 @db.SmallInt

    // How many months is the posting active for
    duration            Int                 @db.SmallInt
    expireDate          DateTime

    // Has the item expired or been deleted?
    deleted             Boolean             @default(true)

    // All reports this post has gotten
    reports             PostReport[]        @relation("ReportedPost")


    // Item info:
    title               String
    description         String              @db.VarChar(500)

    category            String
    price               Decimal             @db.Decimal(6, 2)
    quantity            Int                 @db.SmallInt
    size                ClothingSize?
    shipping            Boolean

    negotiating         Boolean

    images              String[]
}




model PaymentTransaction {
    // Date of transaction
    createdAt           DateTime            @default(now())
    updatedAt           DateTime            @updatedAt
    id                  String              @id @default(cuid())

    // Item the payment is for
    itemId              String              @unique
    item                Item?               @relation("ItemPayment", fields: [itemId], references: [id], onDelete: Cascade)

    // Seller
    userId              String
    user                User                @relation("UserPayments", fields: [userId], references: [id], onDelete: Cascade)

    // Useful Stripe API feedback
    success             Boolean
    msg                 Boolean
}




// Account activation tokens, sent by email
model ActivateToken {
    createdAt           DateTime            @default(now())
    updatedAt           DateTime            @updatedAt
    id                  String              @id @default(cuid())

    token               String              @unique

    userId              String
    user                User                @relation("EmailVerificationToken", fields: [userId], references: [id], onDelete: Cascade)
}




// Token given to users to authorize account actions
// Lets us know if the user is who he says he is
model AuthToken {
    createdAt           DateTime            @default(now())
    updatedAt           DateTime            @updatedAt
    id                  String              @id @default(cuid())

    token               String              @unique

    userId              String
    user                User                @relation("UserAuthToken", fields: [userId], references: [id], onDelete: Cascade)
}



// Token send to a user's email to reset password
model RPToken {
    createdAt           DateTime            @default(now())
    updatedAt           DateTime            @updatedAt
    id                  String              @id @default(cuid())

    token               String

    userId              String
    user                User                @relation("UserResetPasswordToken", fields: [userId], references: [id], onDelete: Cascade)
}



model PostReport {
    createdAt           DateTime            @default(now())
    updatedAt           DateTime            @updatedAt
    id                  String              @id @default(cuid())

    msg                 String

    reporterId          String?
    reporter            User?               @relation("Reporter", fields: [reporterId], references: [id], onDelete: SetNull)

    reportedPostId      String
    reportedPost        Item                @relation("ReportedPost", fields: [reportedPostId], references: [id], onDelete: Cascade)
}



// PromoCode schema exists only for ease of creating and deleting promo codes.
// Schema instances are not attatched to any one user.
model PromoCode {
    createdAt           DateTime            @default(now())
    updatedAt           DateTime            @updatedAt
    id                  String              @id @default(cuid())

    allowedUsers        String[]            @default([])

    code                String              @unique
    freeMonths          Int
}